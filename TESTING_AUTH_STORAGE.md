# Инструкция по тестированию хранения аутентификации в БД

## Автоматическое тестирование (Unit Tests)

### Запуск тестов

**Важно:** Из-за использования общей БД (DatabaseHelper.instance), тесты лучше запускать отдельно:

```bash
# Запустить тесты AuthRepository
flutter test test/auth/auth_repository_test.dart

# Запустить тесты AuthStorage
flutter test test/auth/auth_storage_test.dart

# Запустить с подробным выводом
flutter test test/auth/auth_repository_test.dart --reporter expanded
flutter test test/auth/auth_storage_test.dart --reporter expanded
```

**Примечание:** Если запускать все тесты вместе (`flutter test test/auth/`), они могут конфликтовать из-за общей БД. Рекомендуется запускать тесты по отдельности.

### Что тестируется

#### AuthRepository Tests (`test/auth/auth_repository_test.dart`)
- ✅ Сохранение данных аутентификации (`saveAuth`)
- ✅ Получение всех данных (`getAuth`)
- ✅ Получение API ключа (`getApiKey`)
- ✅ Получение хэша PIN (`getPinHash`)
- ✅ Получение провайдера (`getProvider`)
- ✅ Проверка правильного PIN (`verifyPin` - успешный случай)
- ✅ Проверка неправильного PIN (`verifyPin` - неуспешный случай)
- ✅ Очистка данных (`clearAuth`)
- ✅ Проверка наличия данных (`hasAuth`)
- ✅ Хэширование PIN (`hashPin`)
- ✅ Обновление существующих данных (`saveAuth` - обновление)
- ✅ Шифрование и расшифровка API ключа

#### AuthStorage Tests (`test/auth/auth_storage_test.dart`)
- ✅ Сохранение данных через AuthStorage
- ✅ Получение данных через AuthStorage
- ✅ Все методы делегирования к AuthRepository
- ✅ Проверка PIN через AuthStorage
- ✅ Очистка данных через AuthStorage

## Ручное тестирование через приложение

### Подготовка

1. Убедитесь, что приложение запущено:
   ```bash
   flutter run
   ```

2. Если у вас уже есть сохраненные данные аутентификации, очистите их:
   - Войдите в приложение
   - Нажмите "Сбросить ключ" на экране входа

### Тест 1: Сохранение данных аутентификации

**Шаги:**
1. Откройте приложение
2. Введите валидный API ключ (OpenRouter или VSEGPT)
3. Нажмите "Войти"
4. Дождитесь валидации и генерации PIN

**Ожидаемый результат:**
- ✅ Ключ валидируется успешно
- ✅ Генерируется 4-значный PIN
- ✅ Отображается баланс аккаунта
- ✅ Данные сохраняются в БД

**Проверка в БД (опционально):**
- Можно проверить файл базы данных: `chat_cache.db`
- Использовать SQLite браузер для просмотра таблицы `auth`

### Тест 2: Получение данных

**Шаги:**
1. Закройте приложение полностью
2. Откройте приложение снова
3. Должен появиться экран входа с полем для PIN

**Ожидаемый результат:**
- ✅ Приложение запоминает, что была аутентификация
- ✅ Отображается экран входа с полем PIN
- ✅ Данные успешно загружаются из БД

### Тест 3: Проверка PIN

**Шаги:**
1. Введите правильный PIN (тот, который был показан при первом входе)
2. Нажмите "Войти"

**Ожидаемый результат:**
- ✅ PIN принимается
- ✅ Открывается главный экран приложения
- ✅ API ключ успешно загружается из БД

**Тест неправильного PIN:**
1. Введите неправильный PIN (например, 9999)
2. Нажмите "Войти"

**Ожидаемый результат:**
- ✅ Отображается ошибка "Invalid PIN"
- ✅ Приложение остается на экране входа

### Тест 4: Очистка данных

**Шаги:**
1. На экране входа нажмите "Сбросить ключ"
2. Подтвердите сброс
3. Введите новый API ключ

**Ожидаемый результат:**
- ✅ Старые данные удаляются из БД
- ✅ Можно ввести новый ключ
- ✅ Генерируется новый PIN

### Тест 5: Обновление данных

**Шаги:**
1. Войдите в приложение с существующим PIN
2. Выйдите из приложения (или используйте функцию сброса)
3. Введите новый API ключ (можно тот же или другой)
4. Войдите с новым ключом

**Ожидаемый результат:**
- ✅ Старые данные обновляются в БД
- ✅ Новый ключ сохраняется
- ✅ PIN остается прежним (если не был сброшен)

### Тест 6: Миграция данных (если были старые данные)

**Шаги:**
1. Если у вас были данные в старом формате (flutter_secure_storage + shared_preferences)
2. Откройте приложение
3. Попробуйте войти

**Ожидаемый результат:**
- ✅ Данные автоматически мигрируют в БД
- ✅ Старые хранилища очищаются
- ✅ Приложение работает с новым форматом

## Проверка базы данных напрямую

### На Windows

1. Найдите файл базы данных:
   ```
   %LOCALAPPDATA%\ai_chat\chat_cache.db
   ```

2. Используйте SQLite браузер (например, DB Browser for SQLite):
   - Откройте файл `chat_cache.db`
   - Перейдите на вкладку "Browse Data"
   - Выберите таблицу `auth`
   - Проверьте данные:
     - `api_key` должен быть зашифрован (base64)
     - `pin_hash` должен содержать хэш PIN
     - `provider` должен быть 'openrouter' или 'vsegpt'
     - `created_at` и `last_used` должны содержать даты

### SQL запросы для проверки

```sql
-- Проверить наличие данных
SELECT * FROM auth;

-- Проверить структуру таблицы
PRAGMA table_info(auth);

-- Проверить количество записей (должна быть только одна)
SELECT COUNT(*) FROM auth;
```

## Ожидаемые результаты

После выполнения всех тестов:

- ✅ Данные сохраняются в БД через AuthRepository
- ✅ Данные успешно извлекаются из БД
- ✅ PIN проверяется корректно
- ✅ Данные очищаются при сбросе
- ✅ API ключи шифруются перед сохранением
- ✅ Миграция из старых хранилищ работает (если применимо)
- ✅ Все методы AuthStorage делегируют к AuthRepository

## Устранение проблем

### Если тесты не проходят:

1. Убедитесь, что база данных инициализирована:
   ```dart
   await DatabaseHelper.instance.database;
   ```

2. Проверьте, что таблица `auth` создана:
   ```sql
   SELECT name FROM sqlite_master WHERE type='table' AND name='auth';
   ```

3. Очистите тестовую БД:
   ```dart
   await DatabaseHelper.instance.deleteDatabase();
   ```

### Если ручное тестирование не работает:

1. Проверьте логи приложения в консоли
2. Убедитесь, что API ключ валиден
3. Проверьте, что баланс >= 0
4. Очистите данные и попробуйте снова
